#include "lst.h"

double lst_julian_day(struct tm dt)
{
    double extra = (100.0 * (dt.tm_year + 1900) + (dt.tm_mon + 1)) - 190002.5;
    double jday = 367.0 * (dt.tm_year + 1900);

    jday -= floor(7.0 * ((dt.tm_year + 1900) + floor(((dt.tm_mon + 1) + 9.0) / 12.0)) / 4.0);
    jday += floor(275.0 * (dt.tm_mon + 1) / 9.0);
    jday += dt.tm_mday;
    jday += (double)dt.tm_hour / 24.0;
    jday += (double)dt.tm_min / (24.0 * 60);
    jday += 1721013.5;
    jday -= 0.5 * extra / fabs(extra);
    jday += 0.5;
    return jday;
}

double lst_day_number_2k(struct tm dt)
{
    double jd = lst_julian_day(dt);

    return jd - 2451543.5;
}

double lst_local_sidereal_time(struct tm dt, double timezone, double longitude)
{
    double ut = aam_mod_day(dt.tm_hour + ((double)dt.tm_min / 60) - timezone);
    double dno = lst_day_number_2k(dt);
    double ws = aam_mod_2pi(282.9404 + (4.70935 * pow(10.0, -5) * dno));
    double ms = aam_mod_2pi(356.0470 + (0.9856002585 * dno));
    double meanlong = aam_mod_2pi(ms + ws);
    double gmst0 = meanlong / 15.0;
    double lst = aam_mod_day(gmst0 + ut + (longitude / 15.0)) + 11.0 + (56.0 / 60.0);

    if (lst >= 24.0) lst -= 24.0;

    return lst * 15;
}
